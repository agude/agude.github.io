{%- comment -%}
 Include: check_monotonic_rating.html (Pre-computed List Version)
 Purpose: Checks if a provided list of book titles is monotonically sorted
          by rating (descending) based on data in site.books.
          Uses pre-computed lists of normalized titles for each rating
          and the 'contains' operator for checks.
          Outputs error details and breaks the build in non-production
          environments if the list contains titles not found in site.books
          or if the rating order is violated.

 Parameters:
 - ranked_list: The array/list of book titles to check (e.g., page.ranked_list)
{%- endcomment -%}

{%- capture newline %}
{% endcapture -%}

{%- comment -%} Only perform the check in non-production environments {%- endcomment -%}
{% if jekyll.environment != "production" %}

  {%- comment -%} Ensure the ranked_list parameter was passed {%- endcomment -%}
  {% unless include.ranked_list %}
    {% link ERROR_check_monotonic_rating_include_missing_ranked_list_parameter %}
  {% endunless %}

  {% assign list_to_check = include.ranked_list %}


  {%- comment -%}  STEP 1: Pre-compute Normalized Title Lists per Rating {%- endcomment -%}

  {% assign ratings_to_precompute = "5|4|3|2|1" | split: "|" %}
  {% assign normalized_titles_by_rating = "" | split: "" %} {% comment %} Will hold 5 arrays {% endcomment %}

  {% for rating_val_str in ratings_to_precompute %}
    {% assign rating_val_int = rating_val_str | plus: 0 %}
    {% assign books_in_rating = site.books | where_exp: "item", "item.rating == rating_val_int" %}
    {% assign current_normalized_list = "" | split: "" %}
    {% for book in books_in_rating %}
      {% unless book.title %}{% continue %}{% endunless %}
      {% assign norm_title = book.title | replace: newline, " " | downcase | strip %}
      {% assign current_normalized_list = current_normalized_list | push: norm_title %}
    {% endfor %}
    {% comment %} Store this list. We use push; index 0=5*, 1=4*, etc. {% endcomment %}
    {% assign normalized_titles_by_rating = normalized_titles_by_rating | push: current_normalized_list %}
  {% endfor %}

  {% comment %} Assign specific variables for easier access if needed (optional) {% endcomment %}
  {% assign five_star_titles = normalized_titles_by_rating[0] %}
  {% assign four_star_titles = normalized_titles_by_rating[1] %}
  {% assign three_star_titles = normalized_titles_by_rating[2] %}
  {% assign two_star_titles = normalized_titles_by_rating[3] %}
  {% assign one_star_titles = normalized_titles_by_rating[4] %}


  {%- comment -%}  STEP 2: Single Loop Validation using 'contains'     {%- endcomment -%}

  {% assign previous_rating_found = 6 %} {% comment %} Initialize higher than max possible rating {% endcomment %}

  {% for current_ranked_title in list_to_check %}
    {% assign current_rating_found = 0 %} {% comment %} 0 indicates not found yet {% endcomment %}
    {% assign title_found_in_any_list = false %}

    {% comment %} Normalize the title from the ranked list {% endcomment %}
    {% assign target_title_processed = current_ranked_title | replace: newline, " " | downcase | strip %}

    {% comment %} Check existence and determine rating {% endcomment %}
    {% if five_star_titles contains target_title_processed %}
      {% assign current_rating_found = 5 %}
      {% assign title_found_in_any_list = true %}
    {% elsif four_star_titles contains target_title_processed %}
      {% assign current_rating_found = 4 %}
      {% assign title_found_in_any_list = true %}
    {% elsif three_star_titles contains target_title_processed %}
      {% assign current_rating_found = 3 %}
      {% assign title_found_in_any_list = true %}
    {% elsif two_star_titles contains target_title_processed %}
      {% assign current_rating_found = 2 %}
      {% assign title_found_in_any_list = true %}
    {% elsif one_star_titles contains target_title_processed %}
      {% assign current_rating_found = 1 %}
      {% assign title_found_in_any_list = true %}
    {% endif %}

    {% comment %} Check 1: Did we find the book in *any* rating list? {% endcomment %}
    {% unless title_found_in_any_list %}
      {% link ERROR_ranked_list_book_not_found %}
    {% endunless %}

    {% comment %} Check 2: Is the current rating higher than the previous one? (Violation) {% endcomment %}
    {% if current_rating_found > previous_rating_found %}
       {% link ERROR_monotonic_rating_violation %}
    {% endif %}

    {% comment %} Update previous values for the next iteration {% endcomment %}
    {% assign previous_rating_found = current_rating_found %}

  {% endfor %}
{% endif %}

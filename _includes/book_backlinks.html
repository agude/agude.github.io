{% comment %}
  book_backlinks.html
  Displays a list of other book reviews that link back to the current page.
  Links are sorted alphabetically by the linking book's title (ignoring articles).
{% endcomment %}

{% comment %} Capture a newline character for use in replace filter {% endcomment %}
{%- capture newline %}
{% endcapture -%}

{% comment %} Pre-calculate values needed multiple times {% endcomment %}
{%- assign now_unix = 'now' | date: '%s' | plus: 0 -%}
{%- assign this_url = page.url | downcase -%}
{%- assign this_title_downcased = page.title | downcase -%}

{% comment %}
  Define the patterns to search for within other book contents. We check for
  both the markdown include tag and the potential final HTML link. Escape the
  title for the markdown check in case it contains quotes.
{% endcomment %}
{%- capture target_markdown %}book_link.html title="{{ this_title_downcased | escape_once }}"{% endcapture -%}
{%- capture target_url %}{{ this_url }}{% endcapture -%}

{% comment %}
  Iterate through all books to find those linking back to this page.
  Simultaneously, build a map for sorting them by title later.
{% endcomment %}
{%- assign backlink_title_map = "" | split: "" -%}

{%- for book in site.books -%}
  {% comment %} Skip unpublished posts {% endcomment %}
  {%- assign post_time = book.date | date: '%s' | plus: 0 -%}
  {%- if post_time > now_unix %}
    {% continue %}
  {% endif -%}

  {% comment %} Skip self-references {% endcomment %}
  {%- assign book_url_downcased = book.url | downcase -%}
  {%- if book_url_downcased == this_url %}
    {% continue %}
  {% endif -%}

  {% comment %}
    Check the normalized content for links. Normalizing involves replacing
    newlines with spaces (using captured newline) and lowercasing for
    case-insensitive matching. This is the most expensive part, so we do it
    only after basic checks pass.
  {% endcomment %}
  {%- assign normalized_content = book.content | replace: newline, " " | downcase -%}

  {%- if normalized_content contains target_markdown or normalized_content contains target_url -%}
    {% comment %}
      Found a link. Create a sort key by lowercasing the title,
      removing leading articles ("the ", "a ", "an "), and stripping whitespace.
      Store the key as "sortable_title||original_title".
    {% endcomment %}
    {%- assign original_title = book.title -%}
    {%- assign stripped_title = original_title | downcase | remove: "the " | remove: "a " | remove: "an " | strip -%}
    {%- assign key = stripped_title | append: "||" | append: original_title -%}
    {%- assign backlink_title_map = backlink_title_map | push: key -%}
  {%- endif -%}
{%- endfor -%}

{% comment %} Only render the section if backlinks were found {% endcomment %}
{%- if backlink_title_map.size > 0 -%}
  {% comment %} Sort the collected keys alphabetically {% endcomment %}
  {%- assign sorted_backlink_keys = backlink_title_map | sort -%}

  <!-- Related Books -->
  <aside class="book-backlinks">
    <h2 class="book-backlink-section">Reviews that mention <span
        class="book-title">{{ page.title }}</span></h2>

    <ul class="book-backlink-list">
      {%- for key in sorted_backlink_keys -%}
        {%- assign parts = key | split: "||" -%}
        {%- assign backlink_original_title = parts[1] -%}
        <li class="book-backlink-item">
          {%- include book_link.html title=backlink_original_title -%}
        </li>
      {%- endfor -%}
    </ul>
  </aside>
{%- endif -%}
